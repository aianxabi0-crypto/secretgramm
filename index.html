<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretGram - –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ–Ω–ª–∞–π–Ω –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js">
    <style>
        :root {
            --primary: #1a1f2e;
            --secondary: #252b3d;
            --accent: #6c63ff;
            --accent-dark: #554fd8;
            --danger: #ff4757;
            --success: #2ed573;
            --text: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border: #3a3f52;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text);
        }

        .app-container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            background: var(--primary);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
        }

        /* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-panel {
            width: 80px;
            background: var(--secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            border-right: 1px solid var(--border);
        }

        .logo {
            margin-bottom: 40px;
            text-align: center;
        }

        .logo-icon {
            font-size: 32px;
            color: var(--accent);
            background: linear-gradient(135deg, var(--accent), #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .logo-text {
            font-size: 10px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(108, 99, 255, 0.1);
            color: var(--accent);
        }

        .nav-item.active {
            background: rgba(108, 99, 255, 0.2);
            color: var(--accent);
            box-shadow: 0 0 20px rgba(108, 99, 255, 0.3);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .content-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            background: rgba(26, 31, 46, 0.9);
            backdrop-filter: blur(10px);
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 5px;
        }

        .connection-status.online {
            background: rgba(46, 213, 115, 0.2);
            color: var(--success);
        }

        .connection-status.offline {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–µ–π */
        .panel-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: none;
        }

        .panel-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ü–∞–Ω–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .registration-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 40px;
            background: var(--secondary);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .secret-id-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed var(--accent);
            text-align: center;
        }

        .secret-id {
            font-family: 'Courier New', monospace;
            font-size: 22px;
            letter-spacing: 2px;
            color: var(--success);
            font-weight: 700;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            user-select: all;
            word-break: break-all;
        }

        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }

        .copy-btn:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }

        .captcha-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
        }

        .captcha-text {
            font-size: 24px;
            letter-spacing: 5px;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .captcha-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            text-align: center;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .captcha-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(108, 99, 255, 0.3);
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(108, 99, 255, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* –ü–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤ */
        .chats-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: 100%;
        }

        .chats-list {
            background: var(--secondary);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background: rgba(108, 99, 255, 0.1);
            border-color: rgba(108, 99, 255, 0.3);
        }

        .chat-item.active {
            background: rgba(108, 99, 255, 0.15);
            border-color: var(--accent);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            margin-right: 15px;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-info p {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: auto;
            padding-left: 10px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .offline-dot {
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--secondary);
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            margin-right: 15px;
        }

        .chat-header-info h3 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        .chat-header-info p {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.1);
        }

        .message {
            max-width: 70%;
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: linear-gradient(135deg, var(--accent), #7b6cf5);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-bottom-left-radius: 5px;
        }

        .message-content {
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }

        .message-timer {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .message-input-container {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .secret-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent);
            font-size: 20px;
            transition: all 0.3s;
        }

        .secret-toggle:hover {
            background: rgba(108, 99, 255, 0.1);
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 16px 20px;
            padding-right: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            transition: all 0.3s;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(108, 99, 255, 0.2);
        }

        .message-input.blurred {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(108, 99, 255, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
        .search-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px;
            background: var(--secondary);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .search-box {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 18px 25px;
            padding-left: 60px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border);
            border-radius: 15px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 25px rgba(108, 99, 255, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--accent);
        }

        .search-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(108, 99, 255, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .user-profile {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            border: 1px solid var(--border);
            display: none;
        }

        .user-profile.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            margin: 0 auto 20px;
        }

        .profile-id {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 18px;
            color: var(--success);
            word-break: break-all;
        }

        .start-chat-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .start-chat-btn:hover {
            background: #26c464;
            transform: translateY(-2px);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 25px;
            background: var(--secondary);
            border-left: 4px solid var(--success);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            word-break: break-word;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: #ffa726;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            width: 0%;
            transition: width 1s linear;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 10px;
            width: fit-content;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dark);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1100px) {
            .chats-container {
                grid-template-columns: 1fr;
            }

            .chats-list {
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .nav-panel {
                width: 100%;
                flex-direction: row;
                padding: 15px;
                justify-content: space-around;
            }

            .logo {
                margin-bottom: 0;
            }

            .nav-item {
                margin: 0;
            }

            .content-header {
                padding: 20px;
            }

            .panel-content {
                padding: 20px;
            }

            .registration-container,
            .search-container {
                padding: 20px;
            }

            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="nav-panel">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="logo-text">SECRETGRAM</div>
            </div>

            <a href="#" class="nav-item active" data-panel="registration">
                <i class="fas fa-user-plus nav-icon"></i>
                <span class="nav-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </a>

            <a href="#" class="nav-item" data-panel="chats">
                <i class="fas fa-comments nav-icon"></i>
                <span class="nav-label">–ß–∞—Ç—ã</span>
            </a>

            <a href="#" class="nav-item" data-panel="search">
                <i class="fas fa-search nav-icon"></i>
                <span class="nav-label">–ü–æ–∏—Å–∫</span>
            </a>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="content-area">
            <div class="content-header">
                <h1 id="panelTitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ SecretGram</h1>
                <p id="panelDescription">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π ID –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è</p>
                <div class="connection-status offline" id="connectionStatus">
                    <i class="fas fa-circle"></i>
                    <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="panel-content active" id="registrationPanel">
                <div class="registration-container">
                    <div class="secret-id-display">
                        <h3><i class="fas fa-key"></i> –í–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π ID</h3>
                        <div class="secret-id" id="generatedId">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç ID! –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –ø–æ–∏—Å–∫–∞ –≤–∞—Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
                        </p>
                        <button class="copy-btn" id="copyIdBtn">
                            <i class="far fa-copy"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
                        </button>
                    </div>

                    <div class="captcha-container">
                        <h3><i class="fas fa-shield-alt"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
                        <p>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç</p>
                        <div class="captcha-text" id="captchaText">X9K3L8</div>
                        <input type="text" class="captcha-input" id="captchaInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–∞–ø—á—É...">
                    </div>

                    <button class="generate-btn" id="generateBtn" disabled>
                        <i class="fas fa-bolt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>

                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤ -->
            <div class="panel-content" id="chatsPanel">
                <div class="chats-container">
                    <div class="chats-list" id="chatsList">
                        <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        <div class="empty-chats" id="emptyChats">
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-comment-slash" style="font-size: 50px; margin-bottom: 20px;"></i>
                                <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</h3>
                                <p>–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-area">
                        <div class="chat-header" id="chatHeader" style="display: none;">
                            <div class="chat-header-avatar" id="chatHeaderAvatar">A</div>
                            <div class="chat-header-info">
                                <h3 id="chatHeaderName">–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                                <p id="chatHeaderStatus"><span class="online-dot"></span> –û–Ω–ª–∞–π–Ω</p>
                            </div>
                        </div>

                        <div class="messages-container" id="messagesContainer">
                            <div class="chat-placeholder" id="chatPlaceholder">
                                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                    <i class="fas fa-user-secret" style="font-size: 70px; margin-bottom: 20px; color: var(--accent);"></i>
                                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                                    <p style="font-size: 13px; margin-top: 20px;">
                                        <i class="fas fa-exclamation-triangle"></i> –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
                                    </p>
                                </div>
                            </div>
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <span id="typingUser">–ê–Ω–æ–Ω–∏–º</span> –ø–µ—á–∞—Ç–∞–µ—Ç
                                <div class="typing-dots">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>

                        <div class="message-input-container">
                            <div class="secret-toggle" id="secretToggle">
                                <i class="fas fa-eye"></i>
                            </div>

                            <div class="message-input-wrapper">
                                <textarea class="message-input" id="messageInput" 
                                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 —Å–µ–∫)..." 
                                          rows="1" disabled></textarea>
                            </div>

                            <button class="send-button" id="sendButton" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
            <div class="panel-content" id="searchPanel">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (8-9 —Å–∏–º–≤–æ–ª–æ–≤)...">
                    </div>

                    <button class="search-btn" id="searchBtn">
                        <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>

                    <div class="user-profile" id="userProfile">
                        <div class="profile-avatar" id="profileAvatar">U</div>
                        <h3 id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                        <div class="profile-id" id="profileId">ID1234567</div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            <i class="fas fa-clock"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–µ–¥–∞–≤–Ω–æ
                        </p>
                        <button class="start-chat-btn" id="startChatBtn">
                            <i class="fas fa-comment"></i> –ù–∞—á–∞—Ç—å —á–∞—Ç
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification" id="notification">
        <div id="notificationText">–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
    </div>

    <!-- Socket.io –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUserId = null;
        let currentUserSecretId = null;
        let activeChatId = null;
        let chats = {};
        let messagesData = {};
        let isSecretMode = false;
        let messageTimers = {};
        let socket = null;
        let isConnected = false;
        let typingTimeouts = {};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
            generateCaptcha();
            connectToServer();
        });

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        function connectToServer() {
            const serverUrl = window.location.origin;
            socket = io(serverUrl);

            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                isConnected = true;
                updateConnectionStatus(true);
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞', 'success');

                if (currentUserId) {
                    restoreUserSession();
                }
            });

            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                isConnected = false;
                updateConnectionStatus(false);
                showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });

            socket.on('new_chat', (data) => {
                console.log('üí¨ –ù–æ–≤—ã–π —á–∞—Ç:', data);
                handleNewChat(data);
            });

            socket.on('new_message', (data) => {
                console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                handleNewMessage(data);
            });

            socket.on('message_deleted', (data) => {
                console.log('üóëÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:', data);
                handleMessageDeleted(data);
            });

            socket.on('user_typing', (data) => {
                console.log('‚å®Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç:', data);
                handleUserTyping(data);
            });

            socket.on('user_status_changed', (data) => {
                console.log('üîî –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω:', data);
                handleUserStatusChanged(data);
            });

            socket.on('connect_error', (error) => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');

            if (connected) {
                statusElement.className = 'connection-status online';
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                statusElement.className = 'connection-status offline';
                statusText.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            const savedUserId = localStorage.getItem('secretgram_user_id');
            const savedUserSecretId = localStorage.getItem('secretgram_secret_id');

            if (savedUserId && savedUserSecretId) {
                currentUserId = savedUserId;
                currentUserSecretId = savedUserSecretId;
                document.getElementById('generatedId').textContent = savedUserSecretId;
                document.getElementById('generateBtn').innerHTML = '<i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å ID';
            } else {
                document.getElementById('generatedId').textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É';
            }

            updatePanelUI('registration');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const panel = this.getAttribute('data-panel');

                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');

                    updatePanelUI(panel);
                });
            });

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
            document.getElementById('generateBtn').addEventListener('click', registerUser);

            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID
            document.getElementById('copyIdBtn').addEventListener('click', copyUserId);

            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('searchBtn').addEventListener('click', searchUser);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchUser();
            });

            // –ù–∞—á–∞–ª–æ —á–∞—Ç–∞
            document.getElementById('startChatBtn').addEventListener('click', startNewChat);

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';

                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
                if (activeChatId && isConnected && currentUserId) {
                    clearTimeout(typingTimeouts[activeChatId]);

                    socket.emit('typing', {
                        chatId: activeChatId,
                        userId: currentUserId,
                        isTyping: true
                    });

                    typingTimeouts[activeChatId] = setTimeout(() => {
                        if (activeChatId && isConnected && currentUserId) {
                            socket.emit('typing', {
                                chatId: activeChatId,
                                userId: currentUserId,
                                isTyping: false
                            });
                        }
                    }, 1000);
                }
            });

            // –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º
            document.getElementById('secretToggle').addEventListener('click', toggleSecretMode);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–ø—á–∏
            document.getElementById('captchaInput').addEventListener('input', validateCaptcha);

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(saveAppData, 30000);
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function registerUser() {
            const captchaInput = document.getElementById('captchaInput').value;
            const captchaText = document.getElementById('captchaText').textContent;

            if (captchaInput !== captchaText) {
                showNotification('–ù–µ–≤–µ—Ä–Ω–∞—è –∫–∞–ø—á–∞! –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç–æ—á–Ω–æ –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ.', 'error');
                return;
            }

            if (!isConnected) {
                showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

            try {
                socket.emit('register', (response) => {
                    if (response.success) {
                        currentUserId = response.userId;
                        currentUserSecretId = response.secretId;

                        localStorage.setItem('secretgram_user_id', currentUserId);
                        localStorage.setItem('secretgram_secret_id', currentUserSecretId);

                        document.getElementById('generatedId').textContent = currentUserSecretId;

                        generateCaptcha();
                        document.getElementById('captchaInput').value = '';

                        showNotification(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–∞—à ID: ${currentUserSecretId}`, 'success');

                        generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å ID';

                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤
                        setTimeout(() => {
                            document.querySelector('[data-panel="chats"]').click();
                        }, 1000);
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'error');
                        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                    }
                    generateBtn.disabled = false;
                });
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        function restoreUserSession() {
            if (!isConnected || !currentUserId) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('generatedId').textContent = currentUserSecretId;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
            loadUserChats();
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function searchUser() {
            const searchInput = document.getElementById('searchInput');
            const searchId = searchInput.value.trim();

            if (searchId.length < 8 || searchId.length > 9) {
                showNotification('ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 8-9 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
                return;
            }

            if (searchId === currentUserSecretId) {
                showNotification('–≠—Ç–æ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ID!', 'error');
                return;
            }

            if (!isConnected) {
                showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                return;
            }

            document.getElementById('userProfile').classList.remove('active');

            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.innerHTML;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–æ–∏—Å–∫...';
            searchBtn.disabled = true;

            socket.emit('search_user', { secretId: searchId }, (response) => {
                if (response.success && response.user) {
                    const user = response.user;
                    const avatarLetter = searchId.charAt(0).toUpperCase();

                    document.getElementById('profileAvatar').textContent = avatarLetter;
                    document.getElementById('profileName').textContent = user.username;
                    document.getElementById('profileId').textContent = user.secretId;

                    document.getElementById('userProfile').setAttribute('data-user-id', user.userId);
                    document.getElementById('userProfile').setAttribute('data-secret-id', user.secretId);

                    document.getElementById('userProfile').classList.add('active');

                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω!', 'success');
                } else {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –≤ —Å–µ—Ç–∏', 'error');
                }

                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            });
        }

        // –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function startNewChat() {
            const userProfile = document.getElementById('userProfile');
            const targetUserId = userProfile.getAttribute('data-user-id');
            const secretId = userProfile.getAttribute('data-secret-id');

            if (!targetUserId || !secretId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
                return;
            }

            if (!isConnected) {
                showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                return;
            }

            socket.emit('create_chat', { 
                targetUserId: targetUserId, 
                currentUserId: currentUserId 
            }, (response) => {
                if (response.success) {
                    const chatId = response.chatId;

                    if (!chats[chatId]) {
                        const avatarLetter = secretId.charAt(0).toUpperCase();
                        chats[chatId] = {
                            id: chatId,
                            userId: targetUserId,
                            secretId: secretId,
                            avatarLetter: avatarLetter,
                            username: `–ê–Ω–æ–Ω–∏–º_${secretId.substring(0, 4)}`,
                            lastMessage: '–ß–∞—Ç –Ω–∞—á–∞—Ç',
                            lastMessageTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            createdAt: Date.now(),
                            online: true
                        };

                        messagesData[chatId] = [];

                        showNotification('–ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
                        updatePanelUI('chats');

                        setTimeout(() => {
                            selectChat(chatId);
                        }, 300);
                    } else {
                        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —á–∞—Ç—É
                        updatePanelUI('chats');
                        setTimeout(() => {
                            selectChat(chatId);
                        }, 300);
                    }

                    document.getElementById('searchInput').value = '';
                    document.getElementById('userProfile').classList.remove('active');

                    saveAppData();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞', 'error');
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        function loadUserChats() {
            if (!isConnected || !currentUserId) return;

            socket.emit('get_user_chats', { userId: currentUserId }, (response) => {
                if (response.success) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
                    response.chats.forEach(serverChat => {
                        if (serverChat.otherUser) {
                            const chatId = serverChat.chatId;
                            if (!chats[chatId]) {
                                const avatarLetter = serverChat.otherUser.secretId.charAt(0).toUpperCase();
                                chats[chatId] = {
                                    id: chatId,
                                    userId: 'server_user',
                                    secretId: serverChat.otherUser.secretId,
                                    avatarLetter: avatarLetter,
                                    username: serverChat.otherUser.username,
                                    lastMessage: serverChat.lastMessage ? serverChat.lastMessage.text : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π',
                                    lastMessageTime: serverChat.lastMessage ? serverChat.lastMessage.time : new Date().toLocaleTimeString(),
                                    createdAt: serverChat.lastActivity,
                                    online: serverChat.otherUser.online
                                };
                            }
                        }
                    });

                    updateChatsList();
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function updateChatsList() {
            const chatsList = document.getElementById('chatsList');
            const emptyChats = document.getElementById('emptyChats');
            const chatIds = Object.keys(chats);

            if (chatIds.length === 0) {
                emptyChats.style.display = 'block';
                chatsList.innerHTML = '';
                chatsList.appendChild(emptyChats);
                return;
            }

            emptyChats.style.display = 'none';

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —á–∞—Ç–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const sortedChatIds = chatIds.sort((a, b) => {
                return (chats[b].createdAt || 0) - (chats[a].createdAt || 0);
            });

            let chatsHTML = '';

            sortedChatIds.forEach(chatId => {
                const chat = chats[chatId];
                const lastMessage = chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                const shortMessage = lastMessage.length > 25 ? lastMessage.substring(0, 25) + '...' : lastMessage;

                chatsHTML += `
                    <div class="chat-item ${chatId === activeChatId ? 'active' : ''}" data-chat-id="${chatId}">
                        <div class="chat-avatar" style="background: linear-gradient(135deg, #${getColorFromId(chat.secretId)});">
                            ${chat.avatarLetter}
                        </div>
                        <div class="chat-info">
                            <h3>${chat.username}</h3>
                            <p>
                                <span class="${chat.online ? 'online-dot' : 'offline-dot'}"></span>
                                ${shortMessage}
                            </p>
                        </div>
                        <div class="chat-time">${chat.lastMessageTime}</div>
                    </div>
                `;
            });

            chatsList.innerHTML = chatsHTML;

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —á–∞—Ç–æ–≤
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', function() {
                    const chatId = this.getAttribute('data-chat-id');
                    selectChat(chatId);
                });
            });
        }

        // –í—ã–±–æ—Ä —á–∞—Ç–∞
        function selectChat(chatId) {
            if (!chats[chatId]) return;

            activeChatId = chatId;
            const chat = chats[chatId];

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-chat-id') === chatId) {
                    item.classList.add('active');
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞
            document.getElementById('chatHeaderAvatar').textContent = chat.avatarLetter;
            document.getElementById('chatHeaderName').textContent = chat.username;
            document.getElementById('chatHeaderStatus').innerHTML = `
                <span class="${chat.online ? 'online-dot' : 'offline-dot'}"></span>
                ${chat.online ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
            `;
            document.getElementById('chatHeader').style.display = 'flex';

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            loadChatHistory(chatId);

            // –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;

            // –°–∫—Ä—ã—Ç–∏–µ placeholder
            document.getElementById('chatPlaceholder').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadChatHistory(chatId) {
            if (!isConnected) return;

            socket.emit('get_chat_history', { chatId }, (response) => {
                if (response.success) {
                    messagesData[chatId] = response.messages;
                    renderMessages(chatId);
                }
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            if (!activeChatId || !currentUserId || !isConnected) return;

            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (messageText === '') return;

            socket.emit('send_message', {
                chatId: activeChatId,
                message: messageText,
                userId: currentUserId
            }, (response) => {
                if (response.success) {
                    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
                    messageInput.value = '';
                    messageInput.style.height = 'auto';

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ (—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç —á–µ—Ä–µ–∑ socket)
                    if (!messagesData[activeChatId]) {
                        messagesData[activeChatId] = [];
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
                    if (chats[activeChatId]) {
                        chats[activeChatId].lastMessage = messageText.length > 30 ? messageText.substring(0, 30) + '...' : messageText;
                        chats[activeChatId].lastMessageTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    updateChatsList();
                    saveAppData();

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
                    const tempMessage = {
                        id: 'temp_' + Date.now(),
                        text: messageText,
                        senderId: currentUserId,
                        timestamp: Date.now(),
                        timeString: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        expiresAt: Date.now() + 60000
                    };

                    if (!messagesData[activeChatId]) messagesData[activeChatId] = [];
                    messagesData[activeChatId].push(tempMessage);
                    renderMessages(activeChatId);

                } else {
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        function handleNewMessage(data) {
            const { chatId, message } = data;

            if (!messagesData[chatId]) {
                messagesData[chatId] = [];
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const existingIndex = messagesData[chatId].findIndex(m => m.id === message.id);
            if (existingIndex === -1) {
                messagesData[chatId].push({
                    id: message.id,
                    text: message.text,
                    senderId: message.senderId,
                    timestamp: message.timestamp,
                    timeString: message.timeString,
                    expiresAt: message.expiresAt
                });

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
                if (chats[chatId]) {
                    chats[chatId].lastMessage = message.text.length > 30 ? message.text.substring(0, 30) + '...' : message.text;
                    chats[chatId].lastMessageTime = message.timeString;
                }

                // –ï—Å–ª–∏ —ç—Ç–æ—Ç —á–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (activeChatId === chatId) {
                    renderMessages(chatId);
                }

                updateChatsList();
                saveAppData();

                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —á–∞—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
                if (activeChatId !== chatId) {
                    showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.senderSecretId}`, 'success');
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function handleNewChat(data) {
            const { chatId, withUser } = data;

            if (!chats[chatId]) {
                const avatarLetter = withUser.secretId.charAt(0).toUpperCase();
                chats[chatId] = {
                    id: chatId,
                    userId: withUser.id,
                    secretId: withUser.secretId,
                    avatarLetter: avatarLetter,
                    username: withUser.username,
                    lastMessage: '–ß–∞—Ç –Ω–∞—á–∞—Ç',
                    lastMessageTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    createdAt: Date.now(),
                    online: true
                };

                messagesData[chatId] = [];

                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${withUser.secretId} –Ω–∞—á–∞–ª —Å –≤–∞–º–∏ —á–∞—Ç!`, 'success');

                updateChatsList();
                saveAppData();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function handleMessageDeleted(data) {
            const { chatId, messageId } = data;

            if (messagesData[chatId]) {
                messagesData[chatId] = messagesData[chatId].filter(msg => msg.id !== messageId);

                if (activeChatId === chatId) {
                    renderMessages(chatId);
                }

                // –£–¥–∞–ª—è–µ–º —Ç–∞–π–º–µ—Ä
                if (messageTimers[messageId]) {
                    clearTimeout(messageTimers[messageId]);
                    delete messageTimers[messageId];
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
        function handleUserTyping(data) {
            const { chatId, userId, username, isTyping } = data;

            if (activeChatId === chatId) {
                const typingIndicator = document.getElementById('typingIndicator');
                const typingUser = document.getElementById('typingUser');

                if (isTyping) {
                    typingUser.textContent = username;
                    typingIndicator.style.display = 'flex';
                } else {
                    typingIndicator.style.display = 'none';
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function handleUserStatusChanged(data) {
            const { userId, online } = data;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–æ –≤—Å–µ—Ö —á–∞—Ç–∞—Ö —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            Object.keys(chats).forEach(chatId => {
                if (chats[chatId].userId === userId) {
                    chats[chatId].online = online;
                }
            });

            updateChatsList();

            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            if (activeChatId && chats[activeChatId] && chats[activeChatId].userId === userId) {
                const statusElement = document.getElementById('chatHeaderStatus');
                statusElement.innerHTML = `
                    <span class="${online ? 'online-dot' : 'offline-dot'}"></span>
                    ${online ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
                `;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function renderMessages(chatId) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messages = messagesData[chatId] || [];

            // –°–∫—Ä—ã–≤–∞–µ–º placeholder
            document.getElementById('chatPlaceholder').style.display = 'none';

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫—Ä–æ–º–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è)
            const typingIndicator = document.getElementById('typingIndicator');
            messagesContainer.innerHTML = '';
            if (typingIndicator.style.display === 'flex') {
                messagesContainer.appendChild(typingIndicator);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const sortedMessages = [...messages].sort((a, b) => a.timestamp - b.timestamp);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            sortedMessages.forEach(message => {
                const isSent = message.senderId === currentUserId;
                const timeLeft = Math.max(0, Math.floor((message.expiresAt - Date.now()) / 1000));

                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                messageElement.setAttribute('data-message-id', message.id);
                messageElement.innerHTML = `
                    <div class="message-content">${escapeHtml(message.text)}</div>
                    <div class="message-time">
                        ${message.timeString}
                        ${timeLeft > 0 ? `<span class="message-timer"><i class="fas fa-clock"></i> ${timeLeft}—Å</span>` : ''}
                    </div>
                `;

                messagesContainer.appendChild(messageElement);

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è
                if (timeLeft > 0) {
                    startMessageTimer(message.id, chatId, message.expiresAt);
                }
            });

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function startMessageTimer(messageId, chatId, expiresAt) {
            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–∞–π–º–µ—Ä
            if (messageTimers[messageId]) {
                clearTimeout(messageTimers[messageId]);
            }

            const timeLeft = expiresAt - Date.now();

            if (timeLeft <= 0) {
                deleteMessage(messageId, chatId);
                return;
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
            messageTimers[messageId] = setTimeout(() => {
                deleteMessage(messageId, chatId);
            }, timeLeft);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function deleteMessage(messageId, chatId) {
            if (messagesData[chatId]) {
                messagesData[chatId] = messagesData[chatId].filter(msg => msg.id !== messageId);

                if (activeChatId === chatId) {
                    renderMessages(chatId);
                }

                // –£–¥–∞–ª—è–µ–º —Ç–∞–π–º–µ—Ä
                if (messageTimers[messageId]) {
                    clearTimeout(messageTimers[messageId]);
                    delete messageTimers[messageId];
                }

                saveAppData();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        function toggleSecretMode() {
            const toggleBtn = document.getElementById('secretToggle');
            const messageInput = document.getElementById('messageInput');

            isSecretMode = !isSecretMode;

            if (isSecretMode) {
                messageInput.classList.add('blurred');
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                showNotification('–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω', 'success');
            } else {
                messageInput.classList.remove('blurred');
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                showNotification('–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–∞–Ω–µ–ª–∏
        function updatePanelUI(panel) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.panel-content').forEach(p => {
                p.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
            document.getElementById(panel + 'Panel').classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const titles = {
                registration: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ SecretGram',
                chats: '–í–∞—à–∏ —á–∞—Ç—ã',
                search: '–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
            };

            const descriptions = {
                registration: '–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π ID –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è',
                chats: '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥',
                search: '–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º—É ID –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è'
            };

            document.getElementById('panelTitle').textContent = titles[panel];
            document.getElementById('panelDescription').textContent = descriptions[panel];

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –ø–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤
            if (panel === 'chats' && currentUserId) {
                loadUserChats();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            notificationText.innerHTML = text;
            notification.className = 'notification';

            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }

            notification.style.display = 'block';

            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ø—á–∏
        function generateCaptcha() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let result = '';

            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            document.getElementById('captchaText').textContent = result;
            validateCaptcha();
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–ø—á–∏
        function validateCaptcha() {
            const captchaInput = document.getElementById('captchaInput').value;
            const captchaText = document.getElementById('captchaText').textContent;
            const generateBtn = document.getElementById('generateBtn');

            generateBtn.disabled = !isConnected || (captchaInput !== captchaText);
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID
        function copyUserId() {
            if (!currentUserSecretId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å!', 'error');
                return;
            }

            navigator.clipboard.writeText(currentUserSecretId)
                .then(() => showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success'))
                .catch(() => {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = currentUserSecretId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                });
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ ID
        function getColorFromId(id) {
            const colors = [
                '667eea,764ba2',
                'f093fb,f5576c',
                '4facfe,00f2fe',
                '43e97b,38f9d7',
                'fa709a,fee140',
                '30cfd0,330867',
                'a8edea,fed6e3',
                'd299c2,fef9d7'
            ];

            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }

            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveAppData() {
            try {
                if (currentUserId && currentUserSecretId) {
                    localStorage.setItem('secretgram_user_id', currentUserId);
                    localStorage.setItem('secretgram_secret_id', currentUserSecretId);
                }

                localStorage.setItem('secretgram_chats', JSON.stringify(chats));

                const validMessages = {};
                Object.keys(messagesData).forEach(chatId => {
                    const validChatMessages = messagesData[chatId].filter(msg => msg.expiresAt > Date.now());
                    if (validChatMessages.length > 0) {
                        validMessages[chatId] = validChatMessages;
                    }
                });

                localStorage.setItem('secretgram_messages', JSON.stringify(validMessages));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        setInterval(() => {
            Object.keys(messagesData).forEach(chatId => {
                const now = Date.now();
                messagesData[chatId] = messagesData[chatId].filter(msg => msg.expiresAt > now);

                if (messagesData[chatId].length === 0 && chatId === activeChatId) {
                    document.getElementById('chatPlaceholder').style.display = 'block';
                }
            });

            if (activeChatId) {
                renderMessages(activeChatId);
            }

            saveAppData();
        }, 10000); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        // ==================== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–õ–ò–ï–ù–¢ ====================

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∏–∑ 12 —Å–∏–º–≤–æ–ª–æ–≤
        function generate12CharId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —á–∞—Ç–∞
        function createAnonymousChat() {
            if (!isConnected || !currentUserId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å', 'error');
                return;
            }

            const modalHTML = `
                <div class="modal-overlay" id="anonChatModal" style="display: flex;">
                    <div style="background: var(--secondary); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3 style="margin: 0; color: var(--accent);"><i class="fas fa-user-secret"></i> –°–æ–∑–¥–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç</h3>
                            <button onclick="closeModal('anonChatModal')" style="background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer;">&times;</button>
                        </div>
                        <div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text);">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</label>
                                <input type="text" id="anonChatName" placeholder="–ê–Ω–æ–Ω–∏–º–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text);">–ö–∞—Å—Ç–æ–º–Ω—ã–π ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" id="anonChatCustomId" placeholder="${generate12CharId()}" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text);">
                                    <input type="checkbox" id="anonChatPublic"> –ü—É–±–ª–∏—á–Ω—ã–π (–≤–∏–¥–µ–Ω –≤ –ø–æ–∏—Å–∫–µ)
                                </label>
                                <label style="display: block; margin-bottom: 8px; color: var(--text);">
                                    <input type="checkbox" id="anonChatPassword"> –ó–∞—â–∏—Ç–∏—Ç—å –ø–∞—Ä–æ–ª–µ–º
                                </label>
                            </div>
                            <div id="passwordField" style="margin-bottom: 20px; display: none;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text);">–ü–∞—Ä–æ–ª—å</label>
                                <input type="password" id="anonChatPasswordValue" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text);">
                            </div>
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button onclick="closeModal('anonChatModal')" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: var(--text); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                                <button onclick="submitAnonymousChat()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border: none; border-radius: 10px; color: white; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
            document.getElementById('anonChatPassword').addEventListener('change', function() {
                document.getElementById('passwordField').style.display = this.checked ? 'block' : 'none';
            });
        }

        function submitAnonymousChat() {
            const name = document.getElementById('anonChatName').value.trim();
            const customId = document.getElementById('anonChatCustomId').value.trim();
            const isPublic = document.getElementById('anonChatPublic').checked;
            const hasPassword = document.getElementById('anonChatPassword').checked;
            const password = hasPassword ? document.getElementById('anonChatPasswordValue').value.trim() : null;

            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞', 'error');
                return;
            }

            if (hasPassword && !password) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            socket.emit('create_anonymous_chat', {
                chatName: name,
                creatorId: currentUserId,
                isPublic: isPublic,
                password: password,
                customId: customId || generate12CharId()
            }, (response) => {
                if (response.success) {
                    showNotification(`–ß–∞—Ç "${name}" —Å–æ–∑–¥–∞–Ω! ID: ${response.chatId}`, 'success');
                    closeModal('anonChatModal');

                    // –ö–æ–ø–∏—Ä—É–µ–º ID –≤ –±—É—Ñ–µ—Ä
                    navigator.clipboard.writeText(response.chatId);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                    setTimeout(() => {
                        showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä', 'success');
                    }, 1000);

                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + response.error, 'error');
                }
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
        function sendFile(file, chatId, isChannel = false, channelId = null) {
            if (!isConnected || !currentUserId) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                const fileData = e.target.result;

                socket.emit('upload_file', {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    fileData: fileData,
                    chatId: chatId,
                    userId: currentUserId,
                    isChannel: isChannel,
                    channelId: channelId
                }, (response) => {
                    if (response.success) {
                        showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                    } else {
                        showNotification('–û—à–∏–±–∫–∞: ' + response.error, 'error');
                    }
                });
            };

            reader.readAsDataURL(file);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        function setupFileUpload() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'fileUploadInput';
            fileInput.style.display = 'none';
            fileInput.accept = 'image/*,video/*,audio/*,application/pdf,text/*,.zip,.rar';

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (activeChatId) {
                    sendFile(file, activeChatId);
                } else if (currentChannelId) {
                    sendFile(file, null, true, currentChannelId);
                } else {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                }

                fileInput.value = '';
            });

            document.body.appendChild(fileInput);

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            const messageInputContainer = document.querySelector('.message-input-container');
            if (messageInputContainer && !document.getElementById('attachFileBtn')) {
                const attachBtn = document.createElement('button');
                attachBtn.id = 'attachFileBtn';
                attachBtn.className = 'secret-toggle';
                attachBtn.innerHTML = '<i class="fas fa-paperclip"></i>';
                attachBtn.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª';
                attachBtn.onclick = () => fileInput.click();

                messageInputContainer.insertBefore(attachBtn, messageInputContainer.firstChild);
            }
        }

        // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        function startVoiceRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
                    showRecordingIndicator();

                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                });
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                hideRecordingIndicator();
            }
        }

        function showRecordingIndicator() {
            let indicator = document.getElementById('recordingIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'recordingIndicator';
                indicator.style.cssText = 'position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 15px 25px; border-radius: 10px; z-index: 1000; display: flex; align-items: center; gap: 10px;';
                indicator.innerHTML = '<i class="fas fa-microphone"></i> –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';

                indicator.onclick = stopVoiceRecording;
                document.body.appendChild(indicator);
            }
            indicator.style.display = 'flex';
        }

        function hideRecordingIndicator() {
            const indicator = document.getElementById('recordingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function sendVoiceMessage(audioBlob) {
            if (!isConnected || !currentUserId) return;

            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);

            reader.onload = function() {
                const audioData = reader.result.split(',')[1]; // –£–±–∏—Ä–∞–µ–º data:audio/webm;base64,

                socket.emit('upload_voice_message', {
                    audioData: audioData,
                    duration: Math.floor(audioBlob.size / 16000), // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                    chatId: activeChatId,
                    userId: currentUserId,
                    isChannel: !!currentChannelId,
                    channelId: currentChannelId
                }, (response) => {
                    if (response.success) {
                        showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                    } else {
                        showNotification('–û—à–∏–±–∫–∞: ' + response.error, 'error');
                    }
                });
            };
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
        function setupVoiceButton() {
            const messageInputContainer = document.querySelector('.message-input-container');
            if (messageInputContainer && !document.getElementById('voiceRecordBtn')) {
                const voiceBtn = document.createElement('button');
                voiceBtn.id = 'voiceRecordBtn';
                voiceBtn.className = 'secret-toggle';
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceBtn.title = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ';

                let isRecording = false;

                voiceBtn.addEventListener('mousedown', startVoiceRecording);
                voiceBtn.addEventListener('mouseup', stopVoiceRecording);
                voiceBtn.addEventListener('mouseleave', stopVoiceRecording);

                // –î–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
                voiceBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startVoiceRecording();
                });

                voiceBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    stopVoiceRecording();
                });

                messageInputContainer.insertBefore(voiceBtn, document.getElementById('attachFileBtn')?.nextSibling || messageInputContainer.firstChild);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        socket.on('new_file_message', (data) => {
            const { chatId, isChannel, message, fileInfo } = data;

            // –ï—Å–ª–∏ –º—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ/–∫–∞–Ω–∞–ª–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª
            if ((isChannel && currentChannelId === chatId) || (!isChannel && activeChatId === chatId)) {
                showFileMessage(message, fileInfo);
            } else {
                showNotification(`–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª: ${fileInfo.name}`, 'success');
            }
        });

        function showFileMessage(message, fileInfo) {
            const isImage = fileInfo.type.startsWith('image/');
            const isVideo = fileInfo.type.startsWith('video/');
            const isAudio = fileInfo.type.startsWith('audio/');
            const isPDF = fileInfo.type === 'application/pdf';

            let fileHTML = '';

            if (isImage) {
                fileHTML = `
                    <div class="file-message">
                        <img src="/file/${fileInfo.id}" alt="${fileInfo.name}" style="max-width: 300px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">${fileInfo.name} (${formatFileSize(fileInfo.size)})</div>
                    </div>
                `;
            } else if (isVideo) {
                fileHTML = `
                    <div class="file-message">
                        <video controls style="max-width: 300px; border-radius: 10px; margin-bottom: 10px;">
                            <source src="/file/${fileInfo.id}" type="${fileInfo.type}">
                        </video>
                        <div style="font-size: 12px; color: var(--text-secondary);">${fileInfo.name} (${formatFileSize(fileInfo.size)})</div>
                    </div>
                `;
            } else if (isAudio) {
                fileHTML = `
                    <div class="file-message">
                        <audio controls style="width: 100%; margin-bottom: 10px;">
                            <source src="/file/${fileInfo.id}" type="${fileInfo.type}">
                        </audio>
                        <div style="font-size: 12px; color: var(--text-secondary);">${fileInfo.name} (${formatFileSize(fileInfo.size)})</div>
                    </div>
                `;
            } else {
                fileHTML = `
                    <div class="file-message" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <i class="fas
    </script>
</body>
</html>
